# Activate MOLINFO functionalities
MOLINFO STRUCTURE=../ref.pdb
WHOLEMOLECULES ENTITY0=1-109

# -0.994838 = -57.0 deg (phi)
ALPHABETA ...
ATOMS1=@phi-2 REFERENCE=-0.994838
ATOMS2=@phi-3    
ATOMS3=@phi-4    
ATOMS4=@phi-5    
ATOMS5=@phi-6    
ATOMS6=@phi-7    
ATOMS7=@phi-8    
ATOMS8=@phi-9    
ATOMS9=@phi-10   
label=alphaphi
...

# -0.820305 = -47.0 deg (psi)
ALPHABETA ...
ATOMS1=@psi-2 REFERENCE=-0.820305
ATOMS2=@psi-3    
ATOMS3=@psi-4    
ATOMS4=@psi-5    
ATOMS5=@psi-6    
ATOMS6=@psi-7    
ATOMS7=@psi-8    
ATOMS8=@psi-9    
ATOMS9=@psi-10   
label=alphapsi
...

d: DISTANCE ATOMS=9,99 NOPBC
rg: GYRATION TYPE=RADIUS ATOMS=@protein

# Activate well-tempered metadynamics 
metad: METAD ...
   ARG=alphaphi,alphapsi

   # Deposit a Gaussian every 500 time steps, with initial height equal to 1.2 kJ/mol
   PACE=100000000 HEIGHT=0.0

   # The bias factor should be wisely chosen
   BIASFACTOR=5

   # Gaussian width (sigma) should be chosen based on CV fluctuation in unbiased run
   SIGMA=0.25,0.25

   # Gaussians will be written to file and also stored on grid
   FILE=../HILLS    # NOTE!!! This must point to the HILLS File your metadynamics generated, otherwise you will get weird reweighted output.
   RESTART=YES      # NOTE!!! THIS is also mandatory to read the HILLS file.
...

# Print both collective variables on COLVAR file every 1 steps
PRINT ARG=alphaphi,alphapsi,rg,metad.bias FILE=COLVAR_REWEIGHT STRIDE=1

# Use the metadynamics bias as argument
as: REWEIGHT_BIAS ARG=metad.bias
# Calculate histograms
# using the weights obtained from the metadynamics bias potentials (umbrella-sampling-like reweighting)
# Look at the manual to understand the parameters of the HISTOGRAM action!
abphi: HISTOGRAM ARG=alphaphi STRIDE=1 GRID_MIN=0 GRID_MAX=9 GRID_BIN=100 BANDWIDTH=0.005 LOGWEIGHTS=as 
abpsi: HISTOGRAM ARG=alphapsi STRIDE=1 GRID_MIN=0 GRID_MAX=9 GRID_BIN=100 BANDWIDTH=0.005 LOGWEIGHTS=as 
hrg: HISTOGRAM ARG=rg         STRIDE=1 GRID_MIN=0.3 GRID_MAX=2.00 GRID_BIN=50 BANDWIDTH=0.005 LOGWEIGHTS=as
hdist: HISTOGRAM ARG=d        STRIDE=1 GRID_MIN=0 GRID_MAX=0.32 GRID_BIN=50 BANDWIDTH=0.005 LOGWEIGHTS=as
# Convert histograms h(s) to free energies F(s) = -kBT * log(h(s))
ffphi: CONVERT_TO_FES GRID=abphi 
ffpsi: CONVERT_TO_FES GRID=abpsi 
ffdist: CONVERT_TO_FES GRID=hdist
ffrg: CONVERT_TO_FES GRID=hrg
# Print out the free energies F(s) to file once the entire trajectory is processed
DUMPGRID GRID=ffphi FILE=fes_abphi.dat 
DUMPGRID GRID=ffpsi FILE=fes_abpsi.dat
DUMPGRID GRID=ffdist FILE=fes_dist.dat
DUMPGRID GRID=ffrg FILE=fes_rg.dat
